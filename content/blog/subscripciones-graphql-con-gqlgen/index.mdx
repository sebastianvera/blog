---
title: Suscripciones GraphQL con gqlgen
date: "2020-12-25T23:28:00.000Z"
description: "쯅o sabes c칩mo implementar suscripciones de GraphQL en Golang? Este post explica c칩mo utilizar 
react, apollo y gqlgen"
tags: "ppoker, apipath, react, graphql, real-time, golang, subscriptions,
apollo, qlgen, gqlgen subscriptions"
---

import Figure from '../../../src/components/figure';
import landing from './landing.png';
import reviews from './reviews.png';

A la fecha, no hay tutoriales sobre c칩mo manejar suscripciones de graphql con
[gqlgen] y [apollo], por lo que quiero compartir c칩mo yo he utilizado ambas
tecnolog칤as para desarrollar una simple aplicaci칩n.

> Debo mencionar y dar las gracias a [mtavano] por la construcci칩n del backend
> y la revisi칩n de este post 游녪游녪 游녪.

En este post se asume que tienes un conocimiento b치sico de GraphQL y/o sabes
c칩mo escribir escribir *"queries"* y *"mutations"*.

> Agregar links 

## Aplicaci칩n a desarrollar

La idea es crear una app d칩nde podamos agregar rese침as o "reviews" a usuarios de
github de manera an칩nima. La aplicaci칩n no necesita registrar usuarios y el
칰nico requisito es que podamos ver las rese침as en tiempo real.

<video controls width="100%" src="./ghreviews.webm" type="video/webm">
    Disculpa, tu navegador no es compatible con videos incrustados.
</video>

### Frontend

Comenzaremos primero descomponiendo el frontend, de esta manera tendremos una
visi칩n mas clara de lo que necesitamos una vez que pasemos al Backend.

La apliaci칩n est치 compuesta de dos p치ginas:

#### Landing Page

En esta p치gina tenemos un input para revisar las rese침as de un usuario en
espec칤fico y tambi칠n tenemos la secci칩n de rese침as en vivo, cual estar치
potenciado por [suscripciones GraphQL].

<Figure image={landing}>
  Landing page
</Figure>

#### Review Page

Esta p치gina muestra informaci칩n sobre un usuario de github en espec칤fico, por
ej, avatar, n칰mero de seguidores y de usuarios a los que sigue, 칠sta informaci칩n
la obtendremos con el API de github:
- https://api.github.com/users/:username

El valor para el campo **"REVIEWS"** ser치
enviado por nuestro Backend, pero ya hablaremos de esto m치s adelante. Tambi칠n
hay una secci칩n para dejar una rese침a y finalmente, al igual que en la p치gina
anterior, una secci칩n de rese침as en vivo, pero esta vez son s칩lo rese침as que
pertenecen a este usuario.

<Figure image={reviews}>
  Review page
</Figure>

#### Demo APP

<iframe src="https://codesandbox.io/embed/ghreviews-hu1j9?autoresize=1&fontsize=12&hidenavigation=1&theme=dark"
  style="width:100%; height:500px; border:0; border-radius: 4px; overflow:hidden;"
  title="ghreviews"
  allow="accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; hid; microphone; midi; payment; usb; vr; xr-spatial-tracking"
  sandbox="allow-forms allow-modals allow-popups allow-presentation allow-same-origin allow-scripts"
></iframe>

### GraphQL

Para 칠sta aplicaci칩n tendremos el siguiente schema de GraphQL:

```graphql
# schema.graphql

type Query {
  # No se utiliza pero GraphQL necesita tener al menos 1 query
  getReview(id: ID!): GhReview
}

type Mutation {
  createReview(reviewInput: CreateReviewInput!): GhReview
}

type Subscription {
  feed: GhReviewsEvent!
  feedByUsername(username: String!): GhReviewsEvent!
}

input CreateReviewInput {
  githubUsername: String!
  githubAvatarURL: String!
  content: String!
}

type GhReview {
  id: ID!
  githubUsername: String!
  githubAvatarURL: String!
  content: String!
  createdAt: Int!
}

type GhReviewsEvent {
  total: Int!
  newReviews: [GhReview!]!
}
```

### 쯈u칠 son las suscripciones graphql?

*"Las [suscripciones] son una caracter칤stica de [GraphQL] que permite a un
servidor enviar datos a sus clientes cuando ocurre un evento espec칤fico. Las
suscripciones se implementan normalmente con WebSockets. En esa configuraci칩n,
el servidor mantiene una conexi칩n constante con su cliente suscrito. Esto
tambi칠n rompe el "Ciclo de solicitud-respuesta"(Request-Response-Cycle) que se
utilizaba para todas las interacciones anteriores con la API.*

*En cambio, el cliente abre inicialmente una conexi칩n de larga duraci칩n con el
servidor enviando una consulta de suscripci칩n que especifica en qu칠 evento est치
interesado. Cada vez que se produce este evento en particular, el servidor
utiliza la conexi칩n para enviar los datos del evento al cliente o clientes
suscritos."*

> Literalmente traducido desde: https://www.howtographql.com/graphql-js/7-subscriptions/

### Implementando suscripciones con [Apollo]

En nuestro caso crearemos dos posibles suscripciones:
- **feed**
- **feedByUsername**

```graphql
# schema.graphql

type Subscription {
  feed: GhReviewsEvent!
  feedByUsername(username: String!): GhReviewsEvent!
}

type GhReviewsEvent {
  total: Int!
  newReviews: [GhReview!]!
}

type GhReview {
  id: ID!
  githubUsername: String!
  githubAvatarURL: String!
  content: String!
  createdAt: Int!
}
```

Ambas suscripciones recibir치n un mensaje del tipo `GhReviewsEvent`, en d칩nde
recibiremos:
- `total`: representa la cantidad total de *"reviews"*
- `newReviews`: un arreglo con las nuevas rese침as, por lo general ser치 un
  arreglo de largo 1, a diferencia de la primera vez que el cliente se suscriba,
  en ese caso enviaremos los 20 reviews mas recientes

**Suscripci칩n feed**

Partiremos definiendo c칩mo esperemos consumir la data desde nuestros componentes:

```jsx
function LandingPage() {
  const {
    data: { reviews, total },
    loading,
    error,
  } = useFeed();

  return (
    ...
  );
}
```

Queremos tener un [hook] llamado `useFeed` que nos retorne un objeto `data` que
contenga siempre un arreglo de `reviews` y un `total`. En un inicio la variable
`reviews` ser치 un arreglo vac칤o y `total` ser치 `0`, ya una vez el servidor
emita un `GhReviewsEvent`, actualizaremos sus respectivos valores:

```js
// use-feed.js

import { useState, useEffect } from 'react';
import { gql, useSubscription } from '@apollo/client';

const MAX_REVIEWS = 20;

const FEED_PUBLIC_SUBSCRIPTION = gql`
  subscription PublicFeed {
    feed {
      total
      newReviews {
        id
        content
        githubUsername
        githubAvatarURL
        createdAt
      }
    }
  }
`;

function useFeed() {
  const { data, loading, error } = useSubscription(FEED_PUBLIC_SUBSCRIPTION);

  const total = data?.feed.total ?? 0;
  const reviews = data?.feed.newReviews ?? [];

  return { data: { reviews, total }, loading, error };
}

export default useFeed;
```

Esta implementaci칩n tiene un solo problema, dado que el servidor siempre retorna
nuevos reviews, significa que cada vez que recibamos un `GhReviewsEvent`, perderemos los
reviews anteriores. Para solucionar este problema utilizaremos `useState` y
guardaremos todos los reviews recibidos:

```js
import { useState, useEffect } from 'react';
import { gql, useSubscription } from '@apollo/client';

const MAX_REVIEWS = 20;

const FEED_PUBLIC_SUBSCRIPTION = gql`
  subscription PublicFeed {
    feed {
      total
      newReviews {
        id
        content
        githubUsername
        githubAvatarURL
        createdAt
      }
    }
  }
`;

function useFeed() {
  const { data, loading, error } = useSubscription(FEED_PUBLIC_SUBSCRIPTION);
  const [reviews, setReviews] = useState([]);
  useEffect(() => {
    if (!data || data.feed.newReviews.length === 0) return;

    setReviews((reviews) =>
      [...data.feed.newReviews, ...reviews].slice(0, MAX_REVIEWS),
    );
  }, [data]);

  const total = data?.feed?.total ?? 0;
  return { data: { reviews, total }, loading, error };
}

export default useFeed;
```

[gqlgen]: https://github.com/99designs/gqlgen
[apollo]: https://www.apollographql.com/
[mtavano]: https://github.com/mtavano
[suscripciones GraphQL]: https://www.apollographql.com/docs/react/data/subscriptions/
[suscripciones]: https://www.howtographql.com/graphql-js/7-subscriptions
[graphql]: https://graphql.org/
[hook]: https://es.reactjs.org/docs/hooks-intro.html
